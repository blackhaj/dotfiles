#!/usr/bin/env bash
# Description: Fuzzy find and run a package.json script with the correct package manager

set -e # Exit on error

repoRoot=$(git rev-parse --show-toplevel 2>/dev/null)

if [[ -f pnpm-lock.yaml ]]; then
  packageManager="pnpm"
elif [[ -n "$repoRoot" && -f "$repoRoot/pnpm-lock.yaml" ]]; then
  packageManager="pnpm"
elif [[ -f package-lock.json ]]; then
  packageManager="npm"
elif [[ -n "$repoRoot" && -f "$repoRoot/bun.lock" ]]; then
  packageManager="bun"
elif [[ -f yarn.lock ]]; then
  packageManager="yarn"
fi

sc=$(cat package.json | jq '.scripts | keys[]' | tr -d '\"' | fzf)

if [[ $? = 0 ]]; then
  unifiedAddHistory "$packageManager run $sc"
  $packageManager run "$sc"
fi